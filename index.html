<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Carnicer√≠a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
        .scale-indicator { animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-3xl font-bold text-center mb-2 text-red-600">ü•© Carnicer√≠a</h1>
            <h2 class="text-xl text-center mb-6 text-gray-600">Sistema de Ventas</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Usuario</label>
                    <input type="text" id="loginUser" class="w-full p-2 border rounded" placeholder="admin o vendedor">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Contrase√±a</label>
                    <input type="password" id="loginPass" class="w-full p-2 border rounded" placeholder="Contrase√±a">
                </div>
                <button onclick="login()" class="w-full bg-red-600 text-white p-2 rounded hover:bg-red-700">
                    Ingresar
                </button>
                <div class="text-xs text-gray-500 mt-4 p-3 bg-gray-50 rounded">
                    <p><strong>Admin:</strong> usuario: admin / contrase√±a: admin123</p>
                    <p><strong>Vendedor:</strong> usuario: vendedor / contrase√±a: vendedor123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-red-600 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">ü•© Sistema Carnicer√≠a</h1>
                <div class="flex items-center gap-4">
                    <span id="userDisplay" class="font-medium"></span>
                    <button onclick="logout()" class="bg-red-700 px-4 py-2 rounded hover:bg-red-800">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white shadow">
            <div class="container mx-auto">
                <div class="flex">
                    <button onclick="showTab('sales')" id="tabSales" class="px-6 py-3 font-medium border-b-2 border-red-600">
                        Ventas
                    </button>
                    <button onclick="showTab('admin')" id="tabAdmin" class="px-6 py-3 font-medium text-gray-500 hidden">
                        Administraci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- Sales Section -->
        <div id="salesSection" class="container mx-auto p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Products List -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">Productos Disponibles</h2>
                        <div id="productsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Cart and Weight -->
                <div>
                    <!-- Weight Scale -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h3 class="text-lg font-bold mb-4">‚öñÔ∏è Balanza</h3>
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-600">Modo:</span>
                                <div class="flex gap-2">
                                    <button onclick="setWeightMode('auto')" id="autoMode" class="px-3 py-1 text-sm rounded bg-red-600 text-white">
                                        Autom√°tico
                                    </button>
                                    <button onclick="setWeightMode('manual')" id="manualMode" class="px-3 py-1 text-sm rounded bg-gray-200">
                                        Manual
                                    </button>
                                </div>
                            </div>
                            <div id="autoWeightSection">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="scale-indicator text-green-500 text-2xl">‚óè</span>
                                    <span class="text-sm">Conectado</span>
                                </div>
                                <div class="text-4xl font-bold text-center p-4 bg-gray-50 rounded">
                                    <span id="autoWeight">0.00</span> kg
                                </div>
                            </div>
                            <div id="manualWeightSection" class="hidden">
                                <input type="number" id="manualWeight" step="0.01" min="0" 
                                       class="w-full p-3 text-2xl text-center border rounded" 
                                       placeholder="0.00">
                                <span class="block text-center text-sm text-gray-600 mt-1">kg</span>
                            </div>
                        </div>
                        <div id="selectedProduct" class="mb-4 p-3 bg-blue-50 rounded hidden">
                            <p class="font-medium">Producto seleccionado:</p>
                            <p id="selectedProductName" class="text-lg"></p>
                        </div>
                        <button onclick="addToCart()" class="w-full bg-green-600 text-white p-3 rounded hover:bg-green-700 font-bold">
                            Agregar al Carrito
                        </button>
                    </div>

                    <!-- Cart -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-bold mb-4">üõí Carrito</h3>
                        <div id="cartItems" class="space-y-2 mb-4 max-h-64 overflow-y-auto">
                            <p class="text-gray-500 text-center py-8">Carrito vac√≠o</p>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-xl font-bold">Total:</span>
                                <span id="cartTotal" class="text-2xl font-bold text-red-600">$0.00</span>
                            </div>
                            <div class="space-y-2">
                                <button onclick="processCheckout()" class="w-full bg-red-600 text-white p-3 rounded hover:bg-red-700 font-bold">
                                    Procesar Venta
                                </button>
                                <button onclick="clearCart()" class="w-full bg-gray-300 text-gray-700 p-2 rounded hover:bg-gray-400">
                                    Limpiar Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="container mx-auto p-6 hidden">
            <!-- Admin Tabs -->
            <div class="mb-6 flex gap-2">
                <button onclick="showAdminTab('products')" id="adminTabProducts" class="px-4 py-2 bg-red-600 text-white rounded">
                    üì¶ Productos
                </button>
                <button onclick="showAdminTab('scale')" id="adminTabScale" class="px-4 py-2 bg-gray-300 rounded">
                    ‚öñÔ∏è Balanza
                </button>
                <button onclick="showAdminTab('sales')" id="adminTabSales" class="px-4 py-2 bg-gray-300 rounded">
                    üìä Ventas
                </button>
            </div>

            <!-- Products Management -->
            <div id="adminProductsSection" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Product Management -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">üì¶ Gesti√≥n de Productos</h2>
                    <form onsubmit="addProduct(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nombre del Producto</label>
                            <input type="text" id="productName" required class="w-full p-2 border rounded" placeholder="Ej: Carne de Res">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Precio por Kg ($)</label>
                            <input type="number" id="productPrice" step="0.01" min="0" required class="w-full p-2 border rounded" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Categor√≠a</label>
                            <select id="productCategory" class="w-full p-2 border rounded">
                                <option value="Res">Res</option>
                                <option value="Cerdo">Cerdo</option>
                                <option value="Pollo">Pollo</option>
                                <option value="Cordero">Cordero</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">
                            Agregar Producto
                        </button>
                    </form>

                    <!-- Products List for Admin -->
                    <div class="mt-6">
                        <h3 class="font-bold mb-3">Productos Registrados</h3>
                        <div id="adminProductsList" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">üìà Estad√≠sticas R√°pidas</h2>
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 rounded">
                            <p class="text-sm text-gray-600">Total Productos</p>
                            <p id="statsProducts" class="text-3xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded">
                            <p class="text-sm text-gray-600">Ventas Hoy</p>
                            <p id="statsSalesToday" class="text-3xl font-bold text-green-600">$0.00</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded">
                            <p class="text-sm text-gray-600">Ventas Totales</p>
                            <p id="statsSalesTotal" class="text-3xl font-bold text-purple-600">$0.00</p>
                        </div>
                        <div class="p-4 bg-orange-50 rounded">
                            <p class="text-sm text-gray-600">Total Transacciones</p>
                            <p id="statsTransactions" class="text-3xl font-bold text-orange-600">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scale Configuration -->
            <div id="adminScaleSection" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 max-w-2xl">
                    <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Configuraci√≥n de Balanza</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Puerto Serial</label>
                            <input type="text" id="scalePort" class="w-full p-2 border rounded" placeholder="COM3 o /dev/ttyUSB0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Velocidad (Baud Rate)</label>
                            <select id="scaleBaud" class="w-full p-2 border rounded">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                                <option value="115200">115200</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Protocolo</label>
                            <select id="scaleProtocol" class="w-full p-2 border rounded">
                                <option value="standard">Est√°ndar</option>
                                <option value="toledo">Toledo</option>
                                <option value="mettler">Mettler Toledo</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Tiempo de estabilizaci√≥n (ms)</label>
                            <input type="number" id="scaleStabilization" class="w-full p-2 border rounded" value="1000">
                        </div>
                        <button onclick="saveScaleConfig()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
                            Guardar Configuraci√≥n
                        </button>
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm">
                            <p class="font-medium">‚ö†Ô∏è Nota:</p>
                            <p>Para conexi√≥n real con balanza serial, este sistema debe ejecutarse en un servidor local con acceso a puertos COM.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales History -->
            <div id="adminSalesSection" class="hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">üìä Historial de Ventas</h2>
                        <div class="flex gap-2">
                            <button onclick="exportSales()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                üì• Exportar CSV
                            </button>
                            <button onclick="printSalesReport()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                üñ®Ô∏è Imprimir Reporte
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-1">Fecha Desde</label>
                            <input type="date" id="filterDateFrom" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Fecha Hasta</label>
                            <input type="date" id="filterDateTo" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Usuario</label>
                            <select id="filterUser" class="w-full p-2 border rounded">
                                <option value="">Todos</option>
                                <option value="Administrador">Administrador</option>
                                <option value="Vendedor">Vendedor</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="filterSales()" class="w-full bg-red-600 text-white p-2 rounded hover:bg-red-700">
                                Filtrar
                            </button>
                        </div>
                    </div>

                    <!-- Sales Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-blue-50 rounded">
                            <p class="text-sm text-gray-600">Total Ventas Filtradas</p>
                            <p id="filteredTotal" class="text-2xl font-bold text-blue-600">$0.00</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded">
                            <p class="text-sm text-gray-600">N√∫mero de Transacciones</p>
                            <p id="filteredCount" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded">
                            <p class="text-sm text-gray-600">Ticket Promedio</p>
                            <p id="filteredAverage" class="text-2xl font-bold text-purple-600">$0.00</p>
                        </div>
                    </div>

                    <!-- Sales Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full" id="salesTable">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="text-left p-3">Factura #</th>
                                    <th class="text-left p-3">Fecha</th>
                                    <th class="text-left p-3">Usuario</th>
                                    <th class="text-left p-3">Productos</th>
                                    <th class="text-right p-3">Total</th>
                                    <th class="text-center p-3">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Sales will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="print-area">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-red-600">ü•© CARNICER√çA</h1>
                    <p class="text-gray-600">Sistema de Ventas</p>
                    <p class="text-sm text-gray-500">Tel: (123) 456-7890</p>
                </div>
                
                <div class="border-t border-b py-4 mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">Factura #:</span>
                        <span id="invoiceNumber"></span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-medium">Fecha:</span>
                        <span id="invoiceDate"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-medium">Atendido por:</span>
                        <span id="invoiceUser"></span>
                    </div>
                </div>

                <table class="w-full mb-4">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2">Producto</th>
                            <th class="text-right py-2">Peso (kg)</th>
                            <th class="text-right py-2">Precio/kg</th>
                            <th class="text-right py-2">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceItems">
                        <!-- Items will be added here -->
                    </tbody>
                </table>

                <div class="border-t pt-4">
                    <div class="flex justify-between text-2xl font-bold">
                        <span>TOTAL:</span>
                        <span id="invoiceTotal" class="text-red-600"></span>
                    </div>
                </div>

                <div class="text-center mt-6 text-sm text-gray-500">
                    <p>¬°Gracias por su compra!</p>
                    <p>Vuelva pronto</p>
                </div>
            </div>

            <div class="flex gap-4 mt-6 no-print">
                <button onclick="printInvoice()" class="flex-1 bg-blue-600 text-white p-3 rounded hover:bg-blue-700">
                    üñ®Ô∏è Imprimir
                </button>
                <button onclick="closeInvoice()" class="flex-1 bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Sales Report Print Modal -->
    <div id="salesReportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="print-area">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-red-600">ü•© CARNICER√çA</h1>
                    <h2 class="text-xl text-gray-700 mt-2">Reporte de Ventas</h2>
                </div>
                
                <div class="border-t border-b py-4 mb-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="font-medium">Fecha del Reporte:</span>
                            <span id="reportDate"></span>
                        </div>
                        <div>
                            <span class="font-medium">Per√≠odo:</span>
                            <span id="reportPeriod"></span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="text-center p-4 bg-blue-50 rounded">
                        <p class="text-sm text-gray-600">Total Ventas</p>
                        <p id="reportTotalSales" class="text-2xl font-bold text-blue-600">$0.00</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded">
                        <p class="text-sm text-gray-600">Transacciones</p>
                        <p id="reportTransactions" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded">
                        <p class="text-sm text-gray-600">Ticket Promedio</p>
                        <p id="reportAverage" class="text-2xl font-bold text-purple-600">$0.00</p>
                    </div>
                </div>

                <table class="w-full mb-4">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="text-left p-2">Factura #</th>
                            <th class="text-left p-2">Fecha</th>
                            <th class="text-left p-2">Usuario</th>
                            <th class="text-left p-2">Productos</th>
                            <th class="text-right p-2">Total</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Sales will be added here -->
                    </tbody>
                </table>
            </div>

            <div class="flex gap-4 mt-6 no-print">
                <button onclick="window.print()" class="flex-1 bg-blue-600 text-white p-3 rounded hover:bg-blue-700">
                    üñ®Ô∏è Imprimir
                </button>
                <button onclick="closeSalesReport()" class="flex-1 bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let currentUser = null;
        let userRole = null;
        let products = [];
        let cart = [];
        let scaleConfig = {};
        let weightMode = 'auto';
        let selectedProductForWeight = null;
        let autoWeightInterval = null;
        let invoiceCounter = 1;
        let salesHistory = [];
        let filteredSales = [];

        // Initialize App
        function initApp() {
            loadData();
            if (products.length === 0) {
                loadDefaultProducts();
            }
            startAutoWeightSimulation();
            setTodayDates();
        }

        // Set today's date in filters
        function setTodayDates() {
            const today = new Date().toISOString().split('T')[0];
            const dateFrom = document.getElementById('filterDateFrom');
            const dateTo = document.getElementById('filterDateTo');
            if (dateFrom) dateFrom.value = today;
            if (dateTo) dateTo.value = today;
        }

        // Load data from localStorage
        function loadData() {
            const savedProducts = localStorage.getItem('carniceria_products');
            const savedScaleConfig = localStorage.getItem('carniceria_scaleConfig');
            const savedInvoiceCounter = localStorage.getItem('carniceria_invoiceCounter');
            const savedSalesHistory = localStorage.getItem('carniceria_salesHistory');
            
            if (savedProducts) products = JSON.parse(savedProducts);
            if (savedScaleConfig) {
                scaleConfig = JSON.parse(savedScaleConfig);
                loadScaleConfigToForm();
            }
            if (savedInvoiceCounter) invoiceCounter = parseInt(savedInvoiceCounter);
            if (savedSalesHistory) salesHistory = JSON.parse(savedSalesHistory);
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('carniceria_products', JSON.stringify(products));
            localStorage.setItem('carniceria_scaleConfig', JSON.stringify(scaleConfig));
            localStorage.setItem('carniceria_invoiceCounter', invoiceCounter.toString());
            localStorage.setItem('carniceria_salesHistory', JSON.stringify(salesHistory));
        }

        // Load default products
        function loadDefaultProducts() {
            products = [
                { id: 1, name: 'Carne de Res - Lomo', price: 25.00, category: 'Res' },
                { id: 2, name: 'Carne de Res - Molida', price: 15.00, category: 'Res' },
                { id: 3, name: 'Carne de Cerdo - Chuleta', price: 18.00, category: 'Cerdo' },
                { id: 4, name: 'Pollo - Pechuga', price: 12.00, category: 'Pollo' },
                { id: 5, name: 'Costillas de Cerdo', price: 20.00, category: 'Cerdo' },
            ];
            saveData();
        }

        // Login
        function login() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;

            if (user === 'admin' && pass === 'admin123') {
                currentUser = 'Administrador';
                userRole = 'admin';
                showMainApp();
            } else if (user === 'vendedor' && pass === 'vendedor123') {
                currentUser = 'Vendedor';
                userRole = 'vendedor';
                showMainApp();
            } else {
                alert('Usuario o contrase√±a incorrectos');
            }
        }

        // Show main app
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userDisplay').textContent = currentUser;

            if (userRole === 'admin') {
                document.getElementById('tabAdmin').classList.remove('hidden');
            }

            loadProductsToSales();
            loadProductsToAdmin();
            updateStats();
        }

        // Logout
        function logout() {
            currentUser = null;
            userRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
        }

        // Show tab
        function showTab(tab) {
            if (tab === 'sales') {
                document.getElementById('salesSection').classList.remove('hidden');
                document.getElementById('adminSection').classList.add('hidden');
                document.getElementById('tabSales').classList.add('border-red-600', 'text-black');
                document.getElementById('tabSales').classList.remove('text-gray-500');
                if (document.getElementById('tabAdmin')) {
                    document.getElementById('tabAdmin').classList.remove('border-red-600', 'text-black');
                    document.getElementById('tabAdmin').classList.add('text-gray-500');
                }
            } else {
                document.getElementById('salesSection').classList.add('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
                document.getElementById('tabAdmin').classList.add('border-red-600', 'text-black');
                document.getElementById('tabAdmin').classList.remove('text-gray-500');
                document.getElementById('tabSales').classList.remove('border-red-600', 'text-black');
                document.getElementById('tabSales').classList.add('text-gray-500');
                
                // Load sales when switching to admin
                showAdminTab('products');
            }
        }

        // Show admin tab
        function showAdminTab(tab) {
            // Hide all sections
            document.getElementById('adminProductsSection').classList.add('hidden');
            document.getElementById('adminScaleSection').classList.add('hidden');
            document.getElementById('adminSalesSection').classList.add('hidden');

            // Reset all tab buttons
            document.getElementById('adminTabProducts').classList.remove('bg-red-600', 'text-white');
            document.getElementById('adminTabProducts').classList.add('bg-gray-300');
            document.getElementById('adminTabScale').classList.remove('bg-red-600', 'text-white');
            document.getElementById('adminTabScale').classList.add('bg-gray-300');
            document.getElementById('adminTabSales').classList.remove('bg-red-600', 'text-white');
            document.getElementById('adminTabSales').classList.add('bg-gray-300');

            // Show selected section and highlight tab
            if (tab === 'products') {
                document.getElementById('adminProductsSection').classList.remove('hidden');
                document.getElementById('adminTabProducts').classList.add('bg-red-600', 'text-white');
                document.getElementById('adminTabProducts').classList.remove('bg-gray-300');
                updateStats();
            } else if (tab === 'scale') {
                document.getElementById('adminScaleSection').classList.remove('hidden');
                document.getElementById('adminTabScale').classList.add('bg-red-600', 'text-white');
                document.getElementById('adminTabScale').classList.remove('bg-gray-300');
            } else if (tab === 'sales') {
                document.getElementById('adminSalesSection').classList.remove('hidden');
                document.getElementById('adminTabSales').classList.add('bg-red-600', 'text-white');
                document.getElementById('adminTabSales').classList.remove('bg-gray-300');
                loadSalesHistory();
                filterSales();
            }
        }

        // Update statistics
        function updateStats() {
            const statsProducts = document.getElementById('statsProducts');
            const statsSalesToday = document.getElementById('statsSalesToday');
            const statsSalesTotal = document.getElementById('statsSalesTotal');
            const statsTransactions = document.getElementById('statsTransactions');

            if (!statsProducts) return;

            // Total products
            statsProducts.textContent = products.length;

            // Today's sales
            const today = new Date().toDateString();
            const todaySales = salesHistory.filter(sale => 
                new Date(sale.date).toDateString() === today
            );
            const todayTotal = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            statsSalesToday.textContent = '$' + todayTotal.toFixed(2);

            // Total sales
            const totalSales = salesHistory.reduce((sum, sale) => sum + sale.total, 0);
            statsSalesTotal.textContent = '$' + totalSales.toFixed(2);

            // Total transactions
            statsTransactions.textContent = salesHistory.length;
        }

        // Weight mode
        function setWeightMode(mode) {
            weightMode = mode;
            if (mode === 'auto') {
                document.getElementById('autoMode').classList.add('bg-red-600', 'text-white');
                document.getElementById('autoMode').classList.remove('bg-gray-200');
                document.getElementById('manualMode').classList.remove('bg-red-600', 'text-white');
                document.getElementById('manualMode').classList.add('bg-gray-200');
                document.getElementById('autoWeightSection').classList.remove('hidden');
                document.getElementById('manualWeightSection').classList.add('hidden');
            } else {
                document.getElementById('manualMode').classList.add('bg-red-600', 'text-white');
                document.getElementById('manualMode').classList.remove('bg-gray-200');
                document.getElementById('autoMode').classList.remove('bg-red-600', 'text-white');
                document.getElementById('autoMode').classList.add('bg-gray-200');
                document.getElementById('autoWeightSection').classList.add('hidden');
                document.getElementById('manualWeightSection').classList.remove('hidden');
            }
        }

        // Auto weight simulation
        function startAutoWeightSimulation() {
            autoWeightInterval = setInterval(() => {
                if (weightMode === 'auto') {
                    const weight = (Math.random() * 3 + 0.1).toFixed(2);
                    document.getElementById('autoWeight').textContent = weight;
                }
            }, 1500);
        }

        // Load products to sales
        function loadProductsToSales() {
            const container = document.getElementById('productsList');
            container.innerHTML = '';

            products.forEach(product => {
                const div = document.createElement('div');
                div.className = 'border rounded-lg p-4 hover:shadow-lg cursor-pointer transition';
                div.onclick = () => selectProduct(product);
                div.innerHTML = `
                    <h3 class="font-bold text-lg mb-1">${product.name}</h3>
                    <p class="text-sm text-gray-600 mb-2">${product.category}</p>
                    <p class="text-xl font-bold text-red-600">$${product.price.toFixed(2)}/kg</p>
                `;
                container.appendChild(div);
            });
        }

        // Select product for weighing
        function selectProduct(product) {
            selectedProductForWeight = product;
            document.getElementById('selectedProduct').classList.remove('hidden');
            document.getElementById('selectedProductName').textContent = product.name;
        }

        // Add to cart
        function addToCart() {
            if (!selectedProductForWeight) {
                alert('Por favor selecciona un producto primero');
                return;
            }

            let weight;
            if (weightMode === 'auto') {
                weight = parseFloat(document.getElementById('autoWeight').textContent);
            } else {
                weight = parseFloat(document.getElementById('manualWeight').value);
                if (!weight || weight <= 0) {
                    alert('Por favor ingresa un peso v√°lido');
                    return;
                }
            }

            const subtotal = weight * selectedProductForWeight.price;
            cart.push({
                product: selectedProductForWeight,
                weight: weight,
                subtotal: subtotal
            });

            updateCart();
            document.getElementById('manualWeight').value = '';
            selectedProductForWeight = null;
            document.getElementById('selectedProduct').classList.add('hidden');
        }

        // Update cart display
        function updateCart() {
            const container = document.getElementById('cartItems');
            const totalEl = document.getElementById('cartTotal');

            if (cart.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Carrito vac√≠o</p>';
                totalEl.textContent = '$0.00';
                return;
            }

            container.innerHTML = '';
            let total = 0;

            cart.forEach((item, index) => {
                total += item.subtotal;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-start p-3 bg-gray-50 rounded';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium">${item.product.name}</p>
                        <p class="text-sm text-gray-600">${item.weight.toFixed(2)} kg √ó $${item.product.price.toFixed(2)}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold">$${item.subtotal.toFixed(2)}</p>
                        <button onclick="removeFromCart(${index})" class="text-red-600 text-sm hover:underline">
                            Eliminar
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });

            totalEl.textContent = '$' + total.toFixed(2);
        }

        // Remove from cart
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCart();
        }

        // Clear cart
        function clearCart() {
            if (cart.length === 0) return;
            if (confirm('¬øSeguro que deseas vaciar el carrito?')) {
                cart = [];
                updateCart();
            }
        }

        // Process checkout
        function processCheckout() {
            if (cart.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }

            showInvoice();
        }

        // Show invoice
        function showInvoice() {
            const modal = document.getElementById('invoiceModal');
            const itemsContainer = document.getElementById('invoiceItems');
            
            const saleDate = new Date();
            const invoiceNum = invoiceCounter.toString().padStart(6, '0');
            
            // Set invoice details
            document.getElementById('invoiceNumber').textContent = invoiceNum;
            document.getElementById('invoiceDate').textContent = saleDate.toLocaleString('es-CO');
            document.getElementById('invoiceUser').textContent = currentUser;

            // Add items
            itemsContainer.innerHTML = '';
            let total = 0;

            cart.forEach(item => {
                total += item.subtotal;
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="py-2">${item.product.name}</td>
                    <td class="text-right">${item.weight.toFixed(2)}</td>
                    <td class="text-right">$${item.product.price.toFixed(2)}</td>
                    <td class="text-right font-bold">$${item.subtotal.toFixed(2)}</td>
                `;
                itemsContainer.appendChild(tr);
            });

            document.getElementById('invoiceTotal').textContent = '$' + total.toFixed(2);

            // Save sale to history
            const sale = {
                invoiceNumber: invoiceNum,
                date: saleDate.toISOString(),
                user: currentUser,
                items: JSON.parse(JSON.stringify(cart)),
                total: total
            };
            salesHistory.push(sale);

            modal.classList.remove('hidden');

            // Increment invoice counter
            invoiceCounter++;
            saveData();
            updateStats();
        }

        // Print invoice
        function printInvoice() {
            window.print();
        }

        // Close invoice
        function closeInvoice() {
            document.getElementById('invoiceModal').classList.add('hidden');
            cart = [];
            updateCart();
        }

        // Add product (admin)
        function addProduct(event) {
            event.preventDefault();

            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;

            const newProduct = {
                id: Date.now(),
                name: name,
                price: price,
                category: category
            };

            products.push(newProduct);
            saveData();

            // Reset form
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';

            loadProductsToSales();
            loadProductsToAdmin();
            updateStats();

            alert('Producto agregado exitosamente');
        }

        // Load products to admin
        function loadProductsToAdmin() {
            const container = document.getElementById('adminProductsList');
            if (!container) return;
            
            container.innerHTML = '';

            if (products.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos registrados</p>';
                return;
            }

            products.forEach(product => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded';
                div.innerHTML = `
                    <div>
                        <p class="font-medium">${product.name}</p>
                        <p class="text-sm text-gray-600">${product.category} - $${product.price.toFixed(2)}/kg</p>
                    </div>
                    <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800">
                        üóëÔ∏è
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // Delete product
        function deleteProduct(id) {
            if (confirm('¬øSeguro que deseas eliminar este producto?')) {
                products = products.filter(p => p.id !== id);
                saveData();
                loadProductsToSales();
                loadProductsToAdmin();
                updateStats();
            }
        }

        // Save scale configuration
        function saveScaleConfig() {
            scaleConfig = {
                port: document.getElementById('scalePort').value,
                baud: document.getElementById('scaleBaud').value,
                protocol: document.getElementById('scaleProtocol').value,
                stabilization: document.getElementById('scaleStabilization').value
            };
            saveData();
            alert('Configuraci√≥n de balanza guardada exitosamente');
        }

        // Load scale config to form
        function loadScaleConfigToForm() {
            if (scaleConfig.port) document.getElementById('scalePort').value = scaleConfig.port;
            if (scaleConfig.baud) document.getElementById('scaleBaud').value = scaleConfig.baud;
            if (scaleConfig.protocol) document.getElementById('scaleProtocol').value = scaleConfig.protocol;
            if (scaleConfig.stabilization) document.getElementById('scaleStabilization').value = scaleConfig.stabilization;
        }

        // Load sales history
        function loadSalesHistory() {
            const tbody = document.getElementById('salesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (filteredSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No hay ventas registradas</td></tr>';
                return;
            }

            filteredSales.forEach(sale => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                const date = new Date(sale.date);
                const itemsSummary = sale.items.map(item => item.product.name).join(', ');
                
                tr.innerHTML = `
                    <td class="p-3">#${sale.invoiceNumber}</td>
                    <td class="p-3">${date.toLocaleString('es-CO')}</td>
                    <td class="p-3">${sale.user}</td>
                    <td class="p-3 text-sm">${itemsSummary}</td>
                    <td class="p-3 text-right font-bold">$${sale.total.toFixed(2)}</td>
                    <td class="p-3 text-center">
                        <button onclick="viewSaleDetail(${salesHistory.indexOf(sale)})" class="text-blue-600 hover:underline text-sm">
                            Ver Detalle
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Filter sales
        function filterSales() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const user = document.getElementById('filterUser').value;

            filteredSales = salesHistory.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                
                const dateMatch = (!dateFrom || saleDate >= dateFrom) && 
                                 (!dateTo || saleDate <= dateTo);
                const userMatch = !user || sale.user === user;
                
                return dateMatch && userMatch;
            });

            // Update summary
            const total = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const count = filteredSales.length;
            const average = count > 0 ? total / count : 0;

            document.getElementById('filteredTotal').textContent = '$' + total.toFixed(2);
            document.getElementById('filteredCount').textContent = count;
            document.getElementById('filteredAverage').textContent = '$' + average.toFixed(2);

            loadSalesHistory();
        }

        // View sale detail
        function viewSaleDetail(index) {
            const sale = salesHistory[index];
            let detail = `Factura #${sale.invoiceNumber}\n`;
            detail += `Fecha: ${new Date(sale.date).toLocaleString('es-CO')}\n`;
            detail += `Usuario: ${sale.user}\n\n`;
            detail += `Productos:\n`;
            
            sale.items.forEach(item => {
                detail += `- ${item.product.name}: ${item.weight.toFixed(2)} kg √ó $${item.product.price.toFixed(2)} = $${item.subtotal.toFixed(2)}\n`;
            });
            
            detail += `\nTotal: $${sale.total.toFixed(2)}`;
            
            alert(detail);
        }

        // Export sales to CSV
        function exportSales() {
            if (filteredSales.length === 0) {
                alert('No hay ventas para exportar');
                return;
            }

            let csv = 'Factura,Fecha,Usuario,Productos,Total\n';
            
            filteredSales.forEach(sale => {
                const date = new Date(sale.date).toLocaleString('es-CO');
                const items = sale.items.map(item => `${item.product.name} (${item.weight.toFixed(2)}kg)`).join(' | ');
                csv += `#${sale.invoiceNumber},"${date}",${sale.user},"${items}",${sale.total.toFixed(2)}\n`;
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ventas_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Print sales report
        function printSalesReport() {
            if (filteredSales.length === 0) {
                alert('No hay ventas para imprimir');
                return;
            }

            const modal = document.getElementById('salesReportModal');
            const tbody = document.getElementById('reportTableBody');

            // Set report details
            document.getElementById('reportDate').textContent = new Date().toLocaleString('es-CO');
            
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            let period = 'Todas las ventas';
            if (dateFrom && dateTo) {
                period = `${dateFrom} al ${dateTo}`;
            } else if (dateFrom) {
                period = `Desde ${dateFrom}`;
            } else if (dateTo) {
                period = `Hasta ${dateTo}`;
            }
            document.getElementById('reportPeriod').textContent = period;

            // Set summary
            const total = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const count = filteredSales.length;
            const average = count > 0 ? total / count : 0;

            document.getElementById('reportTotalSales').textContent = '$' + total.toFixed(2);
            document.getElementById('reportTransactions').textContent = count;
            document.getElementById('reportAverage').textContent = '$' + average.toFixed(2);

            // Add sales to table
            tbody.innerHTML = '';
            filteredSales.forEach(sale => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                
                const date = new Date(sale.date);
                const itemsSummary = sale.items.map(item => item.product.name).join(', ');
                
                tr.innerHTML = `
                    <td class="p-2">#${sale.invoiceNumber}</td>
                    <td class="p-2">${date.toLocaleDateString('es-CO')}</td>
                    <td class="p-2">${sale.user}</td>
                    <td class="p-2 text-sm">${itemsSummary}</td>
                    <td class="p-2 text-right font-bold">$${sale.total.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });

            modal.classList.remove('hidden');
        }

        // Close sales report
        function closeSalesReport() {
            document.getElementById('salesReportModal').classList.add('hidden');
        }

        // Initialize when page loads
        window.onload = initApp;
    </script>
</body>
</html>
